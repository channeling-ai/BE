# Flyway 데이터베이스 마이그레이션 가이드

## 개요

Flyway는 데이터베이스 스키마 버전 관리 도구입니다. SQL 파일 기반으로 스키마 변경 이력을 추적하고, 모든 환경에서 일관된 데이터베이스 상태를 유지합니다.

## 설정

### 의존성 (build.gradle)

```groovy
implementation 'org.flywaydb:flyway-core'
implementation 'org.flywaydb:flyway-database-postgresql'
```

### 설정 (application-db.yml)

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: validate  # Flyway가 스키마 관리, JPA는 검증만

  flyway:
    enabled: true
    baseline-on-migrate: true  # 기존 DB에 Flyway 적용 시 필요
    baseline-version: 0
    locations: classpath:db/migration
```

## 마이그레이션 파일 작성

### 파일 위치

```
src/main/resources/db/migration/
```

### 파일 명명 규칙

```
V{버전}__{설명}.sql
```

| 구성 요소 | 설명 | 예시 |
|----------|------|------|
| V | 버전 마이그레이션 접두사 (필수) | V |
| 버전 | 숫자, 점(.) 또는 언더스코어(_) 사용 가능 | 1, 1.1, 1_1 |
| __ | 구분자 (언더스코어 2개, 필수) | __ |
| 설명 | 변경 내용 설명 (언더스코어로 단어 구분) | add_user_table |
| .sql | 확장자 | .sql |

### 예시

```
V1__init.sql                    # 초기 스키마
V2__add_user_role_column.sql    # user 테이블에 role 컬럼 추가
V3__create_order_table.sql      # order 테이블 생성
V4__add_index_on_email.sql      # email 인덱스 추가
V1.1__hotfix_nullable.sql       # 소수점 버전도 가능
```

## 마이그레이션 SQL 작성 예시

### 테이블 생성

```sql
-- V2__create_order_table.sql
CREATE TABLE public.order (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6),
    member_id BIGINT NOT NULL REFERENCES public.member(id),
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(50) NOT NULL
);
```

### 컬럼 추가

```sql
-- V3__add_phone_to_member.sql
ALTER TABLE public.member
ADD COLUMN phone VARCHAR(20);
```

### 컬럼 수정

```sql
-- V4__modify_nickname_length.sql
ALTER TABLE public.member
ALTER COLUMN nickname TYPE VARCHAR(50);
```

### 인덱스 추가

```sql
-- V5__add_index_on_google_email.sql
CREATE INDEX idx_member_google_email ON public.member(google_email);
```

### 데이터 마이그레이션

```sql
-- V6__migrate_status_values.sql
UPDATE public.member
SET status = 'ACTIVE'
WHERE status IS NULL;
```

## 주의사항

### 1. 한번 적용된 마이그레이션은 수정 금지

- Flyway는 체크섬으로 파일 변경을 감지합니다
- 이미 적용된 파일을 수정하면 애플리케이션 시작 실패
- 수정이 필요하면 새 버전의 마이그레이션 파일 생성

### 2. 롤백 불가

- Flyway Community 버전은 자동 롤백을 지원하지 않음
- 롤백이 필요하면 수동으로 역방향 마이그레이션 파일 작성

```sql
-- V7__rollback_phone_column.sql (수동 롤백 예시)
ALTER TABLE public.member DROP COLUMN phone;
```

### 3. 운영 환경 적용 전 테스트 필수

- 로컬/개발 환경에서 먼저 테스트
- 대용량 테이블 변경 시 락(Lock) 주의

### 4. DDL과 DML 분리 권장

```sql
-- 좋은 예: DDL만
-- V2__add_column.sql
ALTER TABLE member ADD COLUMN role VARCHAR(50);

-- V3__set_default_role.sql
UPDATE member SET role = 'USER' WHERE role IS NULL;

-- 나쁜 예: DDL + DML 혼합 (트랜잭션 문제 가능)
ALTER TABLE member ADD COLUMN role VARCHAR(50);
UPDATE member SET role = 'USER';
```

## 실행 흐름

1. 애플리케이션 시작 시 Flyway 자동 실행
2. `flyway_schema_history` 테이블에서 적용 이력 확인
3. 미적용 마이그레이션 파일을 버전 순서대로 실행
4. 실행 결과를 `flyway_schema_history`에 기록

## flyway_schema_history 테이블

Flyway가 자동 생성하는 메타 테이블입니다.

```sql
SELECT * FROM flyway_schema_history ORDER BY installed_rank;
```

| 컬럼 | 설명 |
|------|------|
| installed_rank | 실행 순서 |
| version | 마이그레이션 버전 |
| description | 설명 |
| script | 파일명 |
| checksum | 체크섬 (변경 감지용) |
| installed_on | 실행 시간 |
| success | 성공 여부 |

## 트러블슈팅

### 체크섬 불일치 오류

```
Flyway: Validate failed: Migration checksum mismatch
```

**원인**: 이미 적용된 마이그레이션 파일이 수정됨

**해결**:
```sql
-- 개발 환경에서만 사용 (운영 금지)
DELETE FROM flyway_schema_history WHERE version = '문제버전';
```

### 마이그레이션 실패 후 재시도

```
Flyway: Detected failed migration
```

**해결**:
```sql
-- 실패한 마이그레이션 기록 삭제
DELETE FROM flyway_schema_history WHERE success = false;
```

### 기존 DB에 Flyway 최초 적용

`baseline-on-migrate: true` 설정으로 기존 스키마를 baseline으로 처리합니다. V1 이후 버전부터 적용됩니다.

## 로컬 개발 팁

### Flyway 비활성화 (임시)

```yaml
spring:
  flyway:
    enabled: false
```

### 특정 위치 지정

```yaml
spring:
  flyway:
    locations: classpath:db/migration,filesystem:/custom/path
```

## 참고 자료

- [Flyway 공식 문서](https://flywaydb.org/documentation/)
- [Spring Boot Flyway 가이드](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization.migration-tool.flyway)
